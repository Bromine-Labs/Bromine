---
import Popup from "@/Popup.astro";
import { settingsData } from "@/data/settings.ts";
import { Icon } from "astro-icon/components";

const flatSettingsConfig = settingsData.sections.flatMap(
	(section) => section.settings,
);
---

<Popup
	title="Settings"
	label="Settings"
	triggerIcon="ph:gear-six-bold"
	triggerId="omnibar-settings-btn"
	popupId="settings-popup"
	contentId="settings-popup-content"
	closeBtnId="close-settings-btn"
>
	<div class="space-y-6">
		<script
			async="async"
			data-cfasync="false"
			src="//learningbuildingroughly.com/b113e1888ef757be96cdcc722c0f31c8/invoke.js"
		></script>
		<div id="container-b113e1888ef757be96cdcc722c0f31c8"></div>
		{
			settingsData.sections.map((section) => (
				<section class="border-overlay space-y-4 border-t pt-4 first:border-t-0 first:pt-0">
					<h2 class="text-lg font-medium">{section.title}</h2>
					{section.settings.map((setting) => (
						<div class="flex items-center justify-between gap-4">
							<div class="flex items-center gap-2">
								<label for={setting.id}>{setting.label}</label>
								{setting.description && (
									<button
										class="info-btn hover:text-tertiary transition-colors"
										aria-label={`More info about ${setting.label}`}
										data-description={setting.description}
									>
										<Icon name="ph:info-bold" class="size-4" />
									</button>
								)}
							</div>
							<div class="flex items-center">
								{setting.type === "select" && (
									<select
										id={setting.id}
										class="bg-bg border-overlay focus:border-border rounded-md border p-1 focus:outline-none"
									>
										{setting.options?.map((option) => (
											<option disabled={option.disabled} value={option.value}>
												{option.label}
											</option>
										))}
									</select>
								)}
								{setting.type === "text" && (
									<div class="flex flex-col">
										<input
											type="text"
											id={setting.id}
											class="bg-bg border-overlay focus:border-border w-full rounded-md border p-1 focus:outline-none sm:w-48"
											placeholder={setting.placeholder || ""}
											aria-invalid="false"
											aria-describedby={`${setting.id}-error`}
										/>
										<p
											id={`${setting.id}-error`}
											class="text-primary mt-1 hidden text-xs"
											role="alert"
										/>
									</div>
								)}
								{setting.type === "toggle" && (
									<label class="relative inline-flex cursor-pointer items-center">
										<input
											type="checkbox"
											id={setting.id}
											class="peer sr-only"
										/>
										<div class="bg-input-bg peer peer-focus:ring-tertiary peer-checked:bg-tertiary h-6 w-11 rounded-full peer-focus:ring-2 peer-focus:outline-none after:absolute after:top-[2px] after:left-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:after:translate-x-full peer-checked:after:border-white" />
									</label>
								)}
							</div>
						</div>
					))}
				</section>
			))
		}

		<div
			class="border-overlay flex items-center space-x-3 border-t pt-4 text-lg"
		>
			<a
				href="https://github.com/Hydra-Network/Bromine"
				target="_blank"
				rel="noopener noreferrer"
				aria-label="GitHub Repository"
				class="hover:text-link transition-colors"
			>
				<Icon name="ph:github-logo-bold" />
			</a>
			<a
				href="https://discord.gg/UFTf5rE5fE"
				target="_blank"
				rel="noopener noreferrer"
				aria-label="Discord Server"
				class="hover:text-link transition-colors"
			>
				<Icon name="ph:discord-logo-bold" />
			</a>
			<p class="text-xs">
				Ping: <span id="ping-result" class="font-mono">Pinging...</span>
			</p>
		</div>
		<span class="text-sm">
			<!-- UBGHub Upvote Widget -->
			<a
				href="https://ubghub.org/?site=Bromine&utm_source=https%3A%2F%2Fbromineproxy.netlify.app"
				target="_blank"
				rel="noopener"
				class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-br from-[var(--color-secondary)] to-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-[var(--color-bg)] shadow-md transition-transform duration-300 ease-in-out hover:-translate-y-1 hover:shadow-lg sm:px-3 sm:py-1.5 sm:text-base md:text-lg lg:text-xl"
			>
				<svg class="h-4 w-4 fill-current sm:h-5 sm:w-5" viewBox="0 0 20 20">
					<path d="M3 10l4-4v3h4V2l4 4v14H3V10z"></path>
				</svg>
				<span class="font-bold">Vote on UBGHub</span>
			</a>

			Made with ♥️ by <a
				class="text-link"
				href="https://github.com/Hydra-Network">Hydra Network</a
			>.
		</span>
	</div>

	<div
		id="info-tooltip"
		class="bg-overlay bg-crust border-overlay pointer-events-none absolute z-10 hidden max-w-xs rounded-md border p-2 text-sm shadow-lg"
	>
	</div>
</Popup>
<script define:vars={{ settingsConfig: flatSettingsConfig }}>
	// --- variables ---
	const popupContent = document.getElementById("settings-popup-content");
	const tooltip = document.getElementById("info-tooltip");

	// --- Settings Change ---
	const load = () => {
		settingsConfig.forEach((setting) => {
			const element = document.getElementById(setting.id);
			if (!element) return;

			const storedValue = localStorage.getItem(setting.id);
			const valueToApply = storedValue ?? setting.defaultValue;

			if (setting.type === "toggle") {
				element.checked = valueToApply === "true";
			} else {
				element.value = valueToApply;
			}
		});
	};

	const save = (event) => {
		const { target: element } = event;
		const setting = settingsConfig.find((s) => s.id === element.id);
		if (!setting) return;

		const valueToStore =
			setting.type === "toggle" ? element.checked : element.value;
		localStorage.setItem(setting.id, valueToStore.toString());
	};

	const init = () => {
		load();

		settingsConfig.forEach((setting) => {
			const element = document.getElementById(setting.id);
			if (element) {
				element.addEventListener("change", save);

				if (setting.type === "text" && setting.regex) {
					element.addEventListener("input", ({ target: currentElement }) => {
						const currentSetting = settingsConfig.find(
							(s) => s.id === currentElement.id,
						);
						currentSetting;
					});
				}
			}
		});
	};

	// --- Tooltip ---

	const showTooltip = (button) => {
		const { description } = button.dataset;
		if (!description || !tooltip) return;

		tooltip.textContent = description;
		tooltip.classList.remove("hidden");

		const buttonRect = button.getBoundingClientRect();
		const contentRect = popupContent.getBoundingClientRect();

		tooltip.style.left = "50%";
		tooltip.style.transform = "translateX(-50%)";

		let top = buttonRect.top - contentRect.top + button.offsetHeight + 8;

		if (top + tooltip.offsetHeight > popupContent.clientHeight) {
			top = buttonRect.top - contentRect.top - tooltip.offsetHeight - 8;
		}

		tooltip.style.top = `${top + popupContent.scrollTop}px`;
	};

	const hideTooltip = () => {
		tooltip?.classList.add("hidden");
	};

	// --- Ping ---

	const ping = async () => {
		const url = location.origin;
		const pingResultEl = document.getElementById("ping-result");
		if (!pingResultEl) return;

		pingResultEl.textContent = "Pinging...";
		const startTime = performance.now();

		try {
			await fetch(url, { mode: "no-cors", cache: "no-store" });
			const endTime = performance.now();
			const duration = Math.round(endTime - startTime);
			pingResultEl.textContent = `${duration}ms`;
		} catch (e) {
			pingResultEl.textContent = "Error";
			console.error("Ping failed:", e);
		}
	};

	// --- Event listeners and init ---

	document.addEventListener("popup-opened", ({ detail }) => {
		if (detail?.popupId === "settings-popup") {
			const bookmarksElement = document.getElementById("bookmarks");
			bookmarksElement?.classList.add("hidden");
			ping();
		}
	});

	init();

	document.querySelectorAll(".info-btn").forEach((button) => {
		button.addEventListener("mouseenter", () => showTooltip(button));
		button.addEventListener("mouseleave", hideTooltip);
		button.addEventListener("focus", () => showTooltip(button));
		button.addEventListener("blur", hideTooltip);
	});

	popupContent.addEventListener("scroll", hideTooltip, { passive: true });
</script>
