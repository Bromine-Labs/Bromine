---
import { Icon } from 'astro-icon/components';
---
<!-- Alpine.js script is already included -->

<div class="bg-gray-800 p-2 flex items-center space-x-2 rounded-lg">
  <button
            id="omnibar-back-btn"
            class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:arrow-left" class="w-5 h-5" />
  </button>

  <button id="omnibar-forward-btn" class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:arrow-right" class="w-5 h-5" />
  </button>

  <button id="omnibar-reload-btn" class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:reload" class="w-5 h-5" />
  </button>

  <div class="flex-grow flex items-center bg-gray-900 rounded-md px-3 py-1.5">
    <Icon name="tabler:search" class="w-5 h-5 text-gray-500 mr-2" />
        <form id="uv-form" class="flex-center w-full"> {/* Ensure form takes width */}
  <input spellcheck = "false" autofocus id="uv-address" type="text" placeholder="Search the web freely" class="text-gray-300 bg-transparent w-full focus:outline-none"
        />
    </form>
  </div>

  <button class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:share-3" class="w-5 h-5" />
  </button>

  <button class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:bookmark" class="w-5 h-5" />
  </button>

  <button id="omnibar-new-tab-btn" class="p-1.5 bg-gray-700 rounded-md text-gray-400 hover:bg-gray-600">
    <Icon name="tabler:square-plus" class="w-5 h-5" />
  </button>
</div>

<script>
  import tabStore from '../tabStore.js'; // Path from components/Omnibar.astro to src/tabStore.js

  // Helper function to get the active iframe
  function getActiveIframe() {
    const activeTab = tabStore.getActiveTab();
    if (activeTab && activeTab.iframeId) {
      // Ensure the iframe element actually exists in the DOM
      const iframeElement = document.getElementById(activeTab.iframeId);
      if (!iframeElement) {
          console.error(`getActiveIframe: Iframe element with ID '${activeTab.iframeId}' not found in the DOM.`);
          return null;
      }
      return iframeElement;
    }
    console.warn("getActiveIframe: No active tab found or active tab has no iframeId.");
    return null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const addressInput = document.getElementById('uv-address');
    const newTabButton = document.getElementById('omnibar-new-tab-btn');
    const backButton = document.getElementById('omnibar-back-btn');
    const forwardButton = document.getElementById('omnibar-forward-btn');
    const reloadButton = document.getElementById('omnibar-reload-btn');

    // 1. Set address bar to active tab's URL
    const activeTab = tabStore.getActiveTab();
    if (activeTab && addressInput) {
      addressInput.value = activeTab.url;
    } else if (!activeTab) {
        console.warn("Omnibar: No active tab found on load.");
    } else if (!addressInput) {
        console.error("Omnibar: Address input (uv-address) not found.");
    }

    // 2. "New Tab" button functionality
    if (newTabButton) {
      newTabButton.addEventListener('click', () => {
        console.log("Omnibar: New tab button clicked.");
        tabStore.addTab('about:blank', 'New Tab', true); // Add new tab and set it active
        window.location.reload(); // Reload to reflect changes
      });
    } else {
      console.error("Omnibar: New tab button (omnibar-new-tab-btn) not found.");
    }

    // Placeholder for future: Update address bar when tab changes without full reload
    // ... (existing placeholder comment) ...

    // 3. Back Button Functionality
    if (backButton) {
      backButton.addEventListener('click', () => {
        const iframe = getActiveIframe();
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.history.back();
        } else {
          console.warn("Omnibar: Could not get active iframe for 'back' action.");
        }
      });
    } else {
      console.error("Omnibar: Back button (omnibar-back-btn) not found.");
    }

    // 4. Forward Button Functionality
    if (forwardButton) {
      forwardButton.addEventListener('click', () => {
        const iframe = getActiveIframe();
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.history.forward();
        } else {
          console.warn("Omnibar: Could not get active iframe for 'forward' action.");
        }
      });
    } else {
      console.error("Omnibar: Forward button (omnibar-forward-btn) not found.");
    }

    // 5. Reload Button Functionality
    if (reloadButton) {
      reloadButton.addEventListener('click', () => {
        const iframe = getActiveIframe();
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.location.reload();
        } else {
          console.warn("Omnibar: Could not get active iframe for 'reload' action.");
        }
      });
    } else {
      console.error("Omnibar: Reload button (omnibar-reload-btn) not found.");
    }

    // Note: Stop button is not implemented as per instructions (no existing button to repurpose).
  });
</script>
