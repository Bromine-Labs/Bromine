---
import Layout from "@/Layout.astro";
---

<Layout>
	<aside clas="mx-auto ">
		f
	</aside>
  <main class="w-full max-w-5xl min-w-[700px] mx-auto py-8 px-6">
    <h1 class="text-3xl font-bold mb-6 text-center">AI Chat (Gemini)</h1>

    <div
      id="chat-box"
      class="border border-muted rounded-md p-4 h-[55vh] overflow-y-auto bg-surface"
    ></div>

		<button id="new-chat">new Chat</button>
		<button id="select-chat">select chat</button>
    <form id="chat-form" class="flex gap-3 mt-4 items-center">
      <input
        id="user-input"
        type="text"
        class="flex-1 p-3 border border-muted rounded-md text-base"
        placeholder="Type a message..."
      />

      <button
        type="submit"
        class="bg-overlay text-text px-5 py-2 rounded-md font-medium hover:opacity-90 transition"
      >
        Send
      </button>
    </form>
  </main>

	<script>
    // import { fetch } from "@/utils/fetch.ts";
    
    const form = document.getElementById("chat-form");
    const input = document.getElementById("user-input");
    const newchat = document.getElementById("new-chat");
    const selchat = document.getElementById("select-chat");
    const chatBox = document.getElementById("chat-box");

    const API_URL = "https://text.pollinations.ai/openai";

		let chatstorageid = "messages"
    window.messages = localStorage.getItem(chatstorageid)|| "";

    function addMessage(role, content) {
      const msg = document.createElement("div");
      msg.className =
        role === "user" ? "text-right mb-2" : "text-left mb-2 text-text";

      const span = document.createElement("span");
      span.className =
        "inline-block px-3 py-2 rounded-lg bg-overlay text-text whitespace-pre-wrap";
      span.textContent = content.trim();

      msg.appendChild(span);
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userText = input.value.trim();
      if (!userText) return;

      addMessage("user", userText);
      input.value = "";

			messages += `user:${userText}--MESSAGE END--`

      addMessage("assistant", "Thinking...");

			try {
        const response = await fetch(API_URL + encodeURIComponent(messages));

        const reply = await response.text();

        chatBox.lastChild.remove();
        addMessage("assistant", reply);

        messages += `assistant:${reply}--MESSAGE END--`
				localStorage.setItem(chatstorageid, messages)
      } catch (error) {
        chatBox.lastChild.remove();
        addMessage("assistant", "⚠️ Error connecting to Pollinations API.");
				console.error(error);
      }
		});


		newchat.addEventListener("click", () => {

  window.messages = "";
  chatBox.innerHTML = "";

  chatstorageid = "chat_" + crypto.randomUUID();

  const chats = (localStorage.getItem("chats") || "").split("_").filter(Boolean);
  chats.push(chatstorageid);
  localStorage.setItem("chats", chats.join("_") + "_");

  localStorage.setItem(chatstorageid, messages);
});

		selchat.addEventListener("click", () => {
			const chats = localStorage.getItem('chats')
			const mseag = prompt(chats)
	    console.log(mseag)

		
		  const msseag = localStorage.getItem(mseag)
			const messages_arr = msseag.split("--MESSAGE END--")
	    for(const message of messages_arr) {
		    const fad = message.split(":");
		    const role = fad[0];
		    const text = fad[1];
		    addMessage(role, text)
			}
		})

if (messages.trim() !== "") {
  const messages_arr = messages.split("--MESSAGE END--");
  for (const message of messages_arr) {
    if (!message.includes(":")) continue;   // skip invalid/empty entries
    const [role, text] = message.split(":");
    addMessage(role, text);
  }
}

  </script>
</Layout>

